# nixpacks.toml (in your translation-worker directory)

[phases.setup]
# Attempting to install common build tools and some graphics libraries via Nix packages.
# Exact Nix package names for canvas dependencies can be specific.
# Start with build essentials and common tools.
# Common Nix package names that might provide C/C++ build toolchain and canvas dependencies.
# If these specific names aren't found, the Nixpacks build log should indicate it.
nixPkgs = [
  "gcc",             # GNU Compiler Collection (for C/C++)
  "gnumake",         # make utility
  "pkg-config",      # Helper tool used when compiling applications and libraries
  "cairo",           # Graphics library
  "pango",           # Library for layout and rendering of text
  "libjpeg",         # JPEG image compression library
  "giflib",          # GIF image format library
  "librsvg",         # SVG rendering library
  "nodejs",          # Node.js (includes npm)
  "python3",         # Python 3 for node-gyp
  "which",           # For `which python3` command
  "pixman",          # Low-level pixel manipulation library
  "freetype",        # Font rendering library
  "fontconfig",      # Font configuration and customization library
  "libpng",          # PNG image format library
  "zlib",            # Data compression library
  "xorg.libX11",      # X11 library
  "xorg.libXext",     # X11 extension library
  "xorg.libXrender",  # X11 rendering library
  "xorg.libXtst",     # X11 test library
  "xorg.libXi",       # X11 input library
  "glib",            # General-purpose library
  "harfbuzz",        # Font shaping library
  "expat",           # XML parser library
  "libffi"           # Foreign Function Interface library
  # Sometimes development headers are in separate .dev or .lib packages in Nix
  # e.g., "cairo.dev", "pango.dev". For now, trying the base names.
]

# The top-level aptPkgs might not be the preferred way for Railway's Nixpacks if [phases.setup].nixPkgs is used.
# Commenting out to avoid conflict and focus on the nixPkgs approach first.
# aptPkgs = ["build-essential", "libcairo2-dev", "libpango1.0-dev", "libjpeg-dev", "libgif-dev", "librsvg2-dev"]

# The following phases are often inferred correctly by Nixpacks for a Node.js project
# with a package.json. You can uncomment and customize if needed.

[phases.install]
# Debug: Check python availability and PATH before trying to install
cmds = [
  "echo 'Setting up build environment...'",
  "export PKG_CONFIG_PATH=/nix/var/nix/profiles/default/lib/pkgconfig:/nix/var/nix/profiles/default/share/pkgconfig",
  "export LD_LIBRARY_PATH=/nix/var/nix/profiles/default/lib",
  "export PYTHON=/root/.nix-profile/bin/python3",
  "export PYTHON_COMMAND_PATH=/root/.nix-profile/bin/python3",
  "export npm_config_build_from_source=true",
  "export npm_config_canvas_binary_host_mirror=https://registry.npmmirror.com/-/binary/canvas",
  "export npm_config_canvas_build_from_source=true",
  "export npm_config_canvas_use_system_libs=true",
  "export npm_config_canvas_use_system_cairo=true",
  "export npm_config_canvas_use_system_pango=true",
  "export npm_config_canvas_use_system_pixman=true",
  "export npm_config_canvas_use_system_freetype=true",
  "export npm_config_canvas_use_system_fontconfig=true",
  "export npm_config_canvas_use_system_libpng=true",
  "export npm_config_canvas_use_system_zlib=true",
  "export npm_config_canvas_use_system_jpeg=true",
  "export npm_config_canvas_use_system_gif=true",
  "export npm_config_canvas_use_system_svg=true",
  "echo 'Running npm install...'",
  "npm install --verbose"
]

[phases.build]
cmds = ["npm run build"] # Assumes tsc compilation via `npm run build`

[start]
cmd = "npm run start" # Assumes `node dist/index.js` via `npm run start` 